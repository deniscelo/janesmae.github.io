<div id="related">
    <h3>Related posts</h3>

    <ul class="posts">
        {% assign sameTagPostsCount = 0 %}
        {% for post in site.posts %}
            {% if page.url != post.url %}
                {% assign sameTagCount = 0 %}

                {% for tag in post.tags %}
                    {% if page.tags contains tag %}
                        {% assign sameTagCount = sameTagCount | plus: 1 %}
                    {% endif %}
                {% endfor %}

                {% if sameTagCount >= 2 %}
                    {% assign sameTagPostsCount = sameTagPostsCount | plus: 1 %}
                    <li>
                        <span>{{ post.date | date_to_string }} &raquo;</span> <a href="{{ post.url }}">{{ post.title }}</a>
                    </li>
                {% endif %}
            {% endif %}

            {% if sameTagPostsCount == 0 %}
                {% if forloop.last == true %}
                    There are no related posts
                {% endif %}
            {% endif %}
        {% else %}
            There are no related posts
        {% endfor %}
    </ul>

</div>